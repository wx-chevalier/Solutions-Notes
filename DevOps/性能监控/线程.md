# CPU & 线程

和 CPU 相关的指标主要有以下几个：

- CPU 利用率（CPU Utilization）
- CPU 平均负载（Load Average）
- 上下文切换次数（Context Switch）

常用的工具有 top、ps、uptime、vmstat、pidstat 等。

CPU 异常指标的分析思路包括了：

- CPU 利用率：如果我们观察某段时间系统或应用进程的 CPU 利用率一直很高（单个 core 超过 80%），那么就值得我们警惕了。我们可以多次使用 jstack 命令 dump 应用线程栈查看热点代码，非 Java 应用可以直接使用 perf 进行 CPU 采采样，离线分析采样数据后得到 CPU 执行热点（Java 应用需要符号表进行堆栈信息映射，不能直接使用 perf）。

- CPU 平均负载：平均负载高于 CPU 数量 70%，意味着系统存在瓶颈点，造成负载升高的原因有很多，在这里就不展开了。需要注意的是，通过监控系统监测平均负载的变化趋势，更容易定位问题，有时候大文件的加载等，也会导致平均负载瞬时升高。如果 1 分钟/5 分钟/15 分钟的三个值相差不大，那说明系统负载很平稳，则不用关注，如果这三个值逐渐降低，说明负载在渐渐升高，需要关注整体性能；

- CPU 上下文切换：上下文切换这个指标，并没有经验值可推荐（几十到几万都有可能），这个指标值取决于系统本身的 CPU 性能，以及当前应用工作的情况。但是，如果系统或者应用的上下文切换次数出现数量级的增长，就有很大概率说明存在性能问题，如非自愿上下切换大幅度上升，说明有太多的线程在竞争 CPU。

CPU 上的的一些异动，通常也可以从线程上观测到，但需要注意的是，线程问题并不完全是由 CPU 导致的。与线程相关的指标，主要有下面几个（均都可以通过 JDK 自带的 jstack 工具直接或间接得到）：应用中的总的线程数、应用中各个线程状态的分布、线程锁的使用情况，如死锁、锁分布等。

关于线程，可关注的异常有：线程总数过多（体现在 CPU 就是导致频繁的上下文切换，可能是线程池设置不当）、WAITING/BLOCKED 线程过多（线程数设置过多或锁竞争剧烈）、存在大量消耗 CPU 的线程等。
